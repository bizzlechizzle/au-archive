# Where's Waldo 9: Import Hang After ExifTool - Full Trace Analysis

Date: 2025-11-22
Status: IN PROGRESS

---

## Executive Summary

Import reaches ExifTool and completes metadata extraction (169ms), but then hangs. No more output after ExifTool. Comprehensive logging has been added to trace the exact failure point.

---

## What We Know

### Working Steps (Confirmed by Logs)

1. **file.path fallback** - 15 NEF file paths extracted correctly
2. **IPC communication** - `media:import` reaches main process
3. **Transaction starts** - `begin` query logged
4. **SHA256 calculated** - Hash computed (shown in dup check query)
5. **Duplicate check** - Query runs successfully
6. **ExifTool extraction** - Completes in 169ms

### Where It Hangs

After ExifTool completes, the next step is:
- Step 5b: GPS mismatch check (if metadata has GPS)
- Step 6: `organizeFile()` - Fetch location, create folders, copy file, verify
- Step 7: Insert database record
- Step 8: Delete original (if requested)

**No logs appear for any of these steps** - something is failing silently.

---

## Comprehensive Logging Added

### file-import-service.ts

```typescript
// Batch level
console.log('[FileImport] Starting batch import of', files.length, 'files');
console.log('[FileImport] Transaction started');
console.log('[FileImport] Processing file', i + 1, 'of', files.length, ':', file.originalName);

// Single file level
console.log('[FileImport] === Starting import for:', file.originalName, '===');
console.log('[FileImport] Step 1: Validating file path...');
console.log('[FileImport] Step 2: Calculating SHA256 hash...');
console.log('[FileImport] Step 3: File type determined:', type);
console.log('[FileImport] Step 4: Checking for duplicates...');
console.log('[FileImport] Step 5: Extracting metadata for', file.originalName, 'type:', type);
console.log('[FileImport] Step 5b: Checking GPS mismatch...');
console.log('[FileImport] Step 6: Organizing file to archive...');
console.log('[FileImport] Step 7: Inserting database record...');
console.log('[FileImport] Step 8: Deleting original file...');
console.log('[FileImport] File import COMPLETE:', file.originalName);
```

### organizeFile method

```typescript
console.log('[organizeFile] Starting for:', file.originalName);
console.log('[organizeFile] Fetching location:', file.locid);
console.log('[organizeFile] Location found:', location.locnam);
console.log('[organizeFile] Target path:', targetPath);
console.log('[organizeFile] Path validated');
console.log('[organizeFile] Creating directory:', targetDir);
console.log('[organizeFile] Directory created');
console.log('[organizeFile] Copying file (this may take a while for large files)...');
console.log('[organizeFile] File copied in', Date.now() - copyStart, 'ms');
console.log('[organizeFile] Verifying integrity...');
console.log('[organizeFile] Verification complete in', Date.now() - verifyStart, 'ms');
console.log('[organizeFile] COMPLETE for:', file.originalName);
```

---

## Potential Failure Points

### 1. GPS Mismatch Check

```typescript
if (metadata.gps && GPSValidator.isValidGPS(metadata.gps.lat, metadata.gps.lng)) {
  const location = await this.locationRepo.findById(file.locid);  // <-- Could fail here
  // ...
}
```

If the location repository call fails silently, import hangs.

### 2. organizeFile - Location Fetch

```typescript
const location = await this.locationRepo.findById(file.locid);
if (!location) {
  throw new Error(`Location not found: ${file.locid}`);  // <-- Would throw
}
```

This SHOULD throw an error, but maybe transaction context is swallowing it.

### 3. PathValidator.validateArchivePath

```typescript
if (!PathValidator.validateArchivePath(targetPath, this.archivePath)) {
  throw new Error(`Security: Target path escapes archive directory`);
}
```

If archive path has issues, this could fail silently.

### 4. fs.mkdir with recursive

```typescript
await fs.mkdir(targetDir, { recursive: true });
```

Directory creation could fail due to permissions.

### 5. fs.copyFile

```typescript
await fs.copyFile(file.filePath, targetPath);
```

Copy could fail if:
- Target directory doesn't exist
- Permissions issue
- Disk space

### 6. Transaction Context Issues

The entire import runs inside `this.db.transaction().execute(async (trx) => {...})`. If an error occurs and isn't caught properly, the transaction may hang waiting for something.

---

## User Experience Issues (As Noted)

### 1. Dashboard Locked During Import

**Problem:** User can't navigate or use the app while import runs.

**Cause:** Even with fire-and-forget pattern, the main process is busy with I/O.

**Solution:**
- Process imports in chunks with event loop breathing room
- Use `setImmediate()` between files to allow other IPC calls
- Consider worker threads for heavy I/O

### 2. Sequential Processing ("Like a Turtle")

**Problem:** Files are imported one at a time.

**Per claude.md:** "IMPORT EVERYTHING TO DATABASE FIRST THEN DUMP"

**Current Flow (BAD):**
```
For each file:
  1. Hash
  2. Metadata
  3. Copy
  4. Verify
  5. Insert DB
```

**Expected Flow (BATCH):**
```
Phase 1 (Fast - Collect):
  - Hash ALL files (parallel)
  - Extract metadata ALL files (parallel)

Phase 2 (Fast - DB):
  - Insert ALL records in one transaction

Phase 3 (Background - Files):
  - Copy ALL files to archive
  - Verify integrity
```

---

## Next Steps

1. **Test with comprehensive logging** - See exactly where it hangs
2. **Fix the immediate hang** - Whatever step fails, add error handling
3. **Refactor to batch architecture** - Per claude.md spec
4. **Add chunked processing** - Allow event loop to breathe
5. **Test with real NEF files** - Verify complete flow

---

## Files Modified This Session

| File | Changes |
|------|---------|
| `electron/services/exiftool-service.ts` | Added 30s timeout wrapper |
| `electron/services/file-import-service.ts` | Comprehensive logging throughout |
| `src/pages/LocationDetail.svelte` | Fixed $isImporting, added Select Files |
| `src/stores/import-store.ts` | Global import state management |
| `src/components/ImportProgress.svelte` | Floating progress indicator |
| `src/App.svelte` | Global progress event listener |

---

## Previous Bugs Reference

| Waldo | Issue | Status |
|-------|-------|--------|
| 1 | Preload ESM/CJS mismatch | Fixed |
| 2 | Vite bundler adds ESM wrapper | Fixed |
| 3 | Custom copy plugin for preload | Fixed |
| 4 | webUtils undefined, file.path fallback | Partial (fallback works) |
| 5 | RAW formats missing from extension lists | Fixed |
| 6 | Import UX - blocking, no progress | Implemented (fire-and-forget) |
| 7 | webUtils unavailable, no Select Files, wrong $store | Fixed |
| 8 | ExifTool hang, UI overhaul requests | Partial (timeout added) |
| **9** | **Import hangs after ExifTool, need batch architecture** | **In Progress** |

---

## Test Results

*Will be updated after user tests with comprehensive logging*

```
Expected output when test runs:

[FileImport] Starting batch import of 15 files
[FileImport] Transaction started
[FileImport] Processing file 1 of 15 : _DSC8841.NEF
[FileImport] === Starting import for: _DSC8841.NEF ===
[FileImport] Step 1: Validating file path...
[FileImport] Step 1 complete, sanitized name: _DSC8841.NEF
[FileImport] Step 2: Calculating SHA256 hash...
[FileImport] Step 2 complete in XXX ms, hash: 56e99b23...
[FileImport] Step 3: File type determined: image extension: .nef
[FileImport] Step 4: Checking for duplicates...
[FileImport] Step 4 complete in X ms, duplicate: false
[FileImport] Step 5: Extracting metadata for _DSC8841.NEF type: image
[FileImport] Calling ExifTool for image...
[ExifTool] Starting metadata extraction for: /path/to/_DSC8841.NEF
[ExifTool] Calling exiftool.read() with 30000 ms timeout...
[ExifTool] Extraction completed in 169 ms
[FileImport] ExifTool completed in 169 ms

--- If it hangs here, problem is between ExifTool and Step 6 ---

[FileImport] Step 6: Organizing file to archive...
[organizeFile] Starting for: _DSC8841.NEF
[organizeFile] Fetching location: 5d652250-aa9e-409b-ac74-c629639ea55b
...
```

---

End of Report (will be updated with test results)
