# Where's Waldo 5: RAW Image Format Support Missing

Date: 2025-11-22
Status: RESOLVED

---

## Executive Summary

File import drag-drop was working perfectly - the preload script successfully extracted 15 file paths. The bug was in the `media:expandPaths` handler which filters files by extension. **RAW image formats (NEF, CR2, DNG, etc.) were not in the supported extensions list**, causing all dropped files to be filtered out.

---

## The Problem

### Symptom
User drops 15 `.NEF` (Nikon RAW) files onto the import area. Console shows:
```
[Preload] Total paths extracted: 15
[LocationDetail] Got dropped paths from preload: (15) [...]
```

But import fails with "No supported media files found"

### User's Console Logs (Annotated)

```
[Preload] Drop event captured          <-- WORKING
[Preload] Processing 15 dropped files  <-- WORKING
[Preload] Got path via file.path (fallback): .../_DSC8841.NEF  <-- WORKING
... (15 paths extracted) ...
[Preload] Total paths extracted: 15    <-- WORKING
[Preload] getDroppedFilePaths called, returning 15 paths  <-- WORKING
[LocationDetail] Got dropped paths from preload: (15) [...] <-- WORKING
```

What happens next (invisibly):
1. `expandPaths` is called with 15 `.NEF` paths
2. Each path is checked: `ext = '.nef'`
3. `.nef` is NOT in `supportedExts`
4. ALL 15 files filtered out
5. Returns empty array
6. UI shows "No supported media files found"

---

## Root Cause Analysis

### Bug Location 1: `ipc-handlers.ts:416-420`

```typescript
// media:expandPaths handler
const supportedExts = new Set([
  'jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'webp',  // <-- NO RAW FORMATS
  'mp4', 'mov', 'avi', 'mkv', 'wmv', 'flv', 'webm',
  'pdf', 'doc', 'docx', 'txt', 'rtf', 'odt'
]);
```

Missing RAW formats:
- `nef` (Nikon)
- `cr2`, `cr3` (Canon)
- `arw` (Sony)
- `dng` (Adobe DNG universal)
- `orf` (Olympus)
- `raf` (Fuji)
- `rw2` (Panasonic)
- `pef` (Pentax)
- `srw` (Samsung)

### Bug Location 2: `file-import-service.ts:52`

```typescript
private readonly IMAGE_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.tiff', '.webp'];
// <-- ALSO MISSING RAW FORMATS
```

This would cause a secondary failure even if files passed the first filter.

---

## Why This Wasn't Caught Before

1. Previous whereswaldo reports focused on the **preload script** and **webUtils** issues
2. Those were real bugs that were fixed
3. Once drag-drop started extracting paths, testing stopped
4. Nobody tested with RAW files (probably used .jpg for testing)
5. The extension lists were never audited for completeness

---

## The Fix

### Step 1: Update `ipc-handlers.ts`

Add RAW formats to `supportedExts` in the `media:expandPaths` handler.

### Step 2: Update `file-import-service.ts`

Add RAW formats to `IMAGE_EXTENSIONS` constant.

### Complete List of RAW Formats to Add

```typescript
// Common RAW formats from major camera manufacturers
const RAW_EXTENSIONS = [
  // Nikon
  'nef', 'nrw',
  // Canon
  'cr2', 'cr3', 'crw',
  // Sony
  'arw', 'srf', 'sr2',
  // Adobe DNG (universal)
  'dng',
  // Olympus
  'orf',
  // Fuji
  'raf',
  // Panasonic
  'rw2', 'raw',
  // Pentax
  'pef', 'ptx',
  // Samsung
  'srw',
  // Leica
  'rwl', 'dng',
  // Sigma
  'x3f',
  // Phase One
  'iiq',
  // Hasselblad
  '3fr', 'fff',
  // Kodak
  'dcr', 'kdc',
  // Mamiya
  'mef',
  // Minolta
  'mrw',
  // HEIF/HEIC (iPhone)
  'heic', 'heif',
];
```

---

## Implementation Guide

### For ipc-handlers.ts (line ~416)

Change from:
```typescript
const supportedExts = new Set([
  'jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'webp',
  'mp4', 'mov', 'avi', 'mkv', 'wmv', 'flv', 'webm',
  'pdf', 'doc', 'docx', 'txt', 'rtf', 'odt'
]);
```

Change to:
```typescript
const supportedExts = new Set([
  // Standard images
  'jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'tif', 'webp',
  // RAW formats
  'nef', 'nrw',                     // Nikon
  'cr2', 'cr3', 'crw',              // Canon
  'arw', 'srf', 'sr2',              // Sony
  'dng',                            // Adobe DNG
  'orf',                            // Olympus
  'raf',                            // Fuji
  'rw2', 'raw',                     // Panasonic
  'pef', 'ptx',                     // Pentax
  'srw',                            // Samsung
  'x3f',                            // Sigma
  'heic', 'heif',                   // Apple HEIF
  // Videos
  'mp4', 'mov', 'avi', 'mkv', 'wmv', 'flv', 'webm', 'm4v', 'mts', 'mpg', 'mpeg',
  // Documents
  'pdf', 'doc', 'docx', 'txt', 'rtf', 'odt', 'xls', 'xlsx'
]);
```

### For file-import-service.ts (line ~52)

Change from:
```typescript
private readonly IMAGE_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.tiff', '.webp'];
```

Change to:
```typescript
private readonly IMAGE_EXTENSIONS = [
  // Standard formats
  '.jpg', '.jpeg', '.png', '.gif', '.bmp', '.tiff', '.tif', '.webp',
  // RAW formats
  '.nef', '.nrw',                    // Nikon
  '.cr2', '.cr3', '.crw',            // Canon
  '.arw', '.srf', '.sr2',            // Sony
  '.dng',                            // Adobe DNG
  '.orf',                            // Olympus
  '.raf',                            // Fuji
  '.rw2', '.raw',                    // Panasonic
  '.pef', '.ptx',                    // Pentax
  '.srw',                            // Samsung
  '.x3f',                            // Sigma
  '.heic', '.heif',                  // Apple HEIF
];
```

---

## Verification Steps

After fix:

1. Rebuild: `pnpm run build` or restart `pnpm run dev`
2. Navigate to a location
3. Drag 15 .NEF files onto the import area
4. Check console for:
   ```
   [Preload] Total paths extracted: 15
   [media:import] Starting import with input: ...
   [media:import] Validated input, files count: 15
   ```
5. Should see "Imported 15 files" success message
6. Files should appear in the location's image gallery

---

## Previous Bugs vs This Bug

| Bug | Where | What |
|-----|-------|------|
| Waldo 1 | preload/index.ts | ESM import in CJS file |
| Waldo 2 | vite.config.ts | Vite bundler adding ESM wrapper |
| Waldo 3 | vite.config.ts | Used custom copy plugin |
| Waldo 4 | preload/preload.cjs | webUtils undefined, added file.path fallback |
| **Waldo 5** | **ipc-handlers.ts + file-import-service.ts** | **RAW formats missing from extension lists** |

---

## Lessons Learned

1. **Test with real data** - Using only .jpg files for testing missed this bug
2. **Complete the flow** - Debug ended when paths were extracted, not when import succeeded
3. **Extension lists need maintenance** - As camera manufacturers release new formats, lists need updates
4. **Two-layer validation = two places to fix** - The expandPaths AND import service both filter by extension

---

## Sources

- [Electron webUtils Documentation](https://www.electronjs.org/docs/latest/api/web-utils)
- [Process Sandboxing](https://www.electronjs.org/docs/latest/tutorial/sandbox)
- [Context Isolation](https://www.electronjs.org/docs/latest/tutorial/context-isolation)

---

End of Report
